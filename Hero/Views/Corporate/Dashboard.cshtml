@model IEnumerable<Hero.Models.ViewModels.CorporateEmissionResultViewModel>
@using System.Linq
@using System.Text.Json
@using System.Globalization

@{
    ViewData["Title"] = "Dashboard";

    var hasData = Model != null && Model.Any();
    var years = hasData ? Model.Select(x => x.Year).Distinct().OrderBy(y => y).ToList() : new List<int>();
    var months = Enumerable.Range(1, 12).ToList();

    var ordered = hasData ? Model.OrderBy(x => x.Year).ThenBy(x => x.Month).ToList() : new List<Hero.Models.ViewModels.CorporateEmissionResultViewModel>();
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body { background:#0b0b0b; color:#fff; font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto; }
    .card-dark { background:rgba(30,30,30,0.85); border:1px solid rgba(255,255,255,0.12); border-radius:1rem; transition:.3s; backdrop-filter: blur(8px); }
    .card-dark:hover { transform:translateY(-3px); box-shadow:0 10px 26px rgba(16,185,129,.15); }
    .stat-card { padding:1.25rem; }
    .stat-label { color:#cfcfcf; font-weight:600; font-size:.9rem; }
    .stat-kpi { font-weight:800; font-size:1.1rem; transition:.3s; }
    .stat-card:hover .stat-kpi { animation:pulse 1s infinite; text-shadow:0 0 8px rgba(16,185,129,.6); }
    @@keyframes pulse { 0%{transform:scale(1);} 50%{transform:scale(1.05);} 100%{transform:scale(1);} }
    .chart-container { opacity:0; transform:translateY(20px); transition:opacity .6s ease, transform .6s ease; background:rgba(30,30,30,0.85); border:1px solid rgba(255,255,255,0.12); border-radius:1rem; padding:1rem; }
    .chart-container.visible { opacity:1; transform:translateY(0); }
    .empty-state { text-align:center; padding:3rem; }
    .empty-state img { max-width:200px; margin-bottom:1rem; opacity:.9; }
    .filters .form-select, .filters .btn { border-radius:10px; }
    .carousel-item { padding:1rem; }
    .table-dark-saas { --bs-table-bg:transparent; --bs-table-striped-color:#fff; --bs-table-striped-bg:rgba(255,255,255,0.04); --bs-table-hover-color:#fff; --bs-table-hover-bg:rgba(255,255,255,0.06); color:#fff; border-color:rgba(255,255,255,0.12); }
</style>

<div class="container mt-5 pt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">Corporate Emissions Dashboard</h2>
        <div class="filters d-flex gap-2">
            <select id="yearFilter" class="form-select form-select-sm">
                <option value="">All Years</option>
                @foreach (var y in years)
                {
                    <option value="@y">@y</option>
                }
            </select>
            <select id="monthFilter" class="form-select form-select-sm">
                <option value="">All Months</option>
                @foreach (var m in months)
                {
                    <option value="@m">@m</option>
                }
            </select>
            <button id="exportCsv" class="btn btn-outline-light btn-sm"><i class="bi bi-file-earmark-spreadsheet"></i> CSV</button>
            <button id="exportPdf" class="btn btn-outline-light btn-sm"><i class="bi bi-file-earmark-pdf"></i> PDF</button>
        </div>
    </div>

    @if (!hasData)
    {
        <div class="empty-state">
            <img src="https://cdn-icons-png.flaticon.com/512/4076/4076549.png" alt="No data illustration" />
            <h5>No emissions submitted yet</h5>
            <p class="text-muted">Submit your first month to see insights</p>
            <a href="@Url.Action("Submit","Corporate")" class="btn btn-primary">
                <i class="bi bi-rocket-takeoff"></i> Submit Emissions
            </a>
        </div>
    }
    else
    {
        <!-- KPI carousel for mobile -->
        <div id="kpiCarousel" class="carousel slide d-md-none mb-3" data-bs-ride="carousel">
            <div class="carousel-inner">
                @{
                    var total = ordered.Sum(x => x.TotalEmissions);
                    var elec = ordered.Sum(x => x.ElectricityEmissions);
                    var fuel = ordered.Sum(x => x.FuelEmissions);
                    var trans = ordered.Sum(x => x.TransportEmissions);
                    var waste = ordered.Sum(x => x.WasteEmissions);
                }
                <div class="carousel-item active">
                    <div class="card-dark stat-card">
                        <div class="stat-label">Total</div>
                        <div class="stat-kpi" aria-live="polite">@total.ToString("0.00") kg CO₂</div>
                    </div>
                </div>
                <div class="carousel-item">
                    <div class="card-dark stat-card">
                        <div class="stat-label">Electricity</div>
                        <div class="stat-kpi text-success">@elec.ToString("0.00") kg</div>
                    </div>
                </div>
                <div class="carousel-item">
                    <div class="card-dark stat-card">
                        <div class="stat-label">Fuel</div>
                        <div class="stat-kpi text-info">@fuel.ToString("0.00") kg</div>
                    </div>
                </div>
                <div class="carousel-item">
                    <div class="card-dark stat-card">
                        <div class="stat-label">Transport</div>
                        <div class="stat-kpi text-primary">@trans.ToString("0.00") kg</div>
                    </div>
                </div>
                <div class="carousel-item">
                    <div class="card-dark stat-card">
                        <div class="stat-label">Waste</div>
                        <div class="stat-kpi text-warning">@waste.ToString("0.00") kg</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- KPI grid for desktop -->
        <div class="row g-3 d-none d-md-flex" id="kpiGrid">
            <div class="col-md-2"><div class="card-dark stat-card"><div class="stat-label">Total</div><div id="kpiTotal" class="stat-kpi" aria-live="polite">@total.ToString("0.00") kg CO₂</div></div></div>
            <div class="col-md-2"><div class="card-dark stat-card"><div class="stat-label">Electricity</div><div id="kpiElec" class="stat-kpi text-success">@elec.ToString("0.00") kg</div></div></div>
            <div class="col-md-2"><div class="card-dark stat-card"><div class="stat-label">Fuel</div><div id="kpiFuel" class="stat-kpi text-info">@fuel.ToString("0.00") kg</div></div></div>
            <div class="col-md-2"><div class="card-dark stat-card"><div class="stat-label">Transport</div><div id="kpiTrans" class="stat-kpi text-primary">@trans.ToString("0.00") kg</div></div></div>
            <div class="col-md-2"><div class="card-dark stat-card"><div class="stat-label">Waste</div><div id="kpiWaste" class="stat-kpi text-warning">@waste.ToString("0.00") kg</div></div></div>
        </div>

        <!-- Charts row -->
        <div class="row g-3 mt-3">
            <div class="col-lg-4 col-12"><div class="chart-container" id="compContainer"><canvas id="compositionChart" height="250"></canvas></div></div>
            <div class="col-lg-4 col-12"><div class="chart-container" id="barContainer"><canvas id="barChart" height="250"></canvas></div></div>
            <div class="col-lg-4 col-12"><div class="chart-container" id="trendContainer"><canvas id="trendChart" height="250"></canvas></div></div>
        </div>

        <!-- Breakdown table -->
        <div class="card-dark mt-3 p-3">
            <div class="table-responsive">
                <table class="table table-dark-saas table-striped align-middle">
                    <thead><tr><th>Month/Year</th><th>Electricity</th><th>Fuel</th><th>Transport</th><th>Waste</th><th>Total</th></tr></thead>
                    <tbody id="breakdownBody">
                        @foreach (var row in ordered)
                        {
                            <tr data-year="@row.Year" data-month="@row.Month">
                                <td>@row.Month/@row.Year</td>
                                <td>@row.ElectricityEmissions.ToString("0.00") kg</td>
                                <td>@row.FuelEmissions.ToString("0.00") kg</td>
                                <td>@row.TransportEmissions.ToString("0.00") kg</td>
                                <td>@row.WasteEmissions.ToString("0.00") kg</td>
                                <td>@row.TotalEmissions.ToString("0.00") kg</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

<script>
const rows = @Html.Raw(JsonSerializer.Serialize(ordered.Select(r => new {
    year = r.Year, month = r.Month,
    elec = r.ElectricityEmissions, fuel = r.FuelEmissions, trans = r.TransportEmissions, waste = r.WasteEmissions,
    total = r.TotalEmissions
}), new JsonSerializerOptions { WriteIndented = false }));

let compChart, barChart, trendChart;

function initCharts() {
    const compCtx = document.getElementById('compositionChart')?.getContext('2d');
    const barCtx  = document.getElementById('barChart')?.getContext('2d');
    const trendCtx= document.getElementById('trendChart')?.getContext('2d');

    const totals = rows.reduce((a,r)=>({
        elec:a.elec+r.elec, fuel:a.fuel+r.fuel, trans:a.trans+r.trans, waste:a.waste+r.waste, total:a.total+r.total
    }), {elec:0,fuel:0,trans:0,waste:0,total:0});

    if(compCtx){
        compChart = new Chart(compCtx,{
            type:'doughnut',
            data:{labels:['Electricity','Fuel','Transport','Waste'],datasets:[{data:[totals.elec,totals.fuel,totals.trans,totals.waste],backgroundColor:['rgba(16,185,129,0.85)','rgba(14,165,233,0.85)','rgba(59,130,246,0.85)','rgba(245,158,11,0.85)'],borderColor:'rgba(255,255,255,0.6)',borderWidth:1.5}]},
            options:{responsive:true, cutout:'62%', plugins:{legend:{position:'bottom',labels:{color:'#fff',usePointStyle:true,pointStyle:'circle'}},tooltip:{callbacks:{label:(ctx)=>{const val=ctx.parsed; const total=compChart.data.datasets[0].data.reduce((a,b)=>a+b,0); const pct=total>0?((val/total)*100).toFixed(1):'0.0'; return `${ctx.label}: ${val.toFixed(2)} kg (${pct}%)`;}}}}}
        });
    }

    if(barCtx){
        const grad = barCtx.createLinearGradient(0,0,0,300);
        grad.addColorStop(0,'rgba(16,185,129,0.9)'); grad.addColorStop(1,'rgba(16,185,129,0.2)');
        barChart = new Chart(barCtx,{
            type:'bar',
            data:{labels:['Electricity','Fuel','Transport','Waste','Total'],datasets:[{label:'CO₂ Emissions (kg)',data:[totals.elec,totals.fuel,totals.trans,totals.waste,totals.total],backgroundColor:[grad,grad,grad,grad,'rgba(16,185,129,0.95)'],borderColor:'rgba(16,185,129,1)',borderWidth:2,borderRadius:6,maxBarThickness:44}]},
            options:{responsive:true,plugins:{legend:{labels:{color:'#fff'}}},scales:{x:{ticks:{color:'#fff',font:{weight:600}},grid:{color:'rgba(255,255,255,0.08)'}},y:{beginAtZero:true,ticks:{color:'#fff',font:{weight:600}},grid:{color:'rgba(255,255,255,0.08)'}}}}
        });
    }

    if(trendCtx){
        const sorted = rows.slice().sort((a,b)=> (a.year-b.year)||(a.month-b.month));
        trendChart = new Chart(trendCtx,{
            type:'line',
            data:{labels:sorted.map(r=>`${r.month}/${r.year}`),datasets:[{label:'Total Emissions (kg CO₂)',data:sorted.map(r=>r.total),fill:false,borderColor:'rgba(16,185,129,0.9)',backgroundColor:'rgba(16,185,129,0.5)',tension:0.3,pointRadius:4,pointBackgroundColor:'rgba(16,185,129,0.9)'}]},
            options:{responsive:true,plugins:{legend:{labels:{color:'#fff'}}},scales:{x:{ticks:{color:'#fff'},grid:{color:'rgba(255,255,255,0.08)'}},y:{beginAtZero:true,ticks:{color:'#fff'},grid:{color:'rgba(255,255,255,0.08)'}}}}
        });
    }
}

function updateCharts(compData, barData, trendLabels, trendTotals){
    if(compChart){compChart.data.datasets[0].data = compData; compChart.update();}
    if(barChart){barChart.data.datasets[0].data = barData; barChart.update();}
    if(trendChart){trendChart.data.labels = trendLabels; trendChart.data.datasets[0].data = trendTotals; trendChart.update();}
}

function applyFilters(){
    const y = document.getElementById('yearFilter').value;
    const m = document.getElementById('monthFilter').value;
    const filtered = rows.filter(r => (y==='' || r.year===parseInt(y)) && (m==='' || r.month===parseInt(m)));

    const tbody = document.getElementById('breakdownBody');
    tbody.innerHTML = '';
    if(filtered.length===0){
        tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">No records for selected filters</td></tr>`;
        updateCharts([0,0,0,0],[0,0,0,0,0],[],[]);
        ['kpiTotal','kpiElec','kpiFuel','kpiTrans','kpiWaste'].forEach(id=>{const el=document.getElementById(id); if(el) el.textContent='0.00 kg';});
        return;
    }
    filtered.sort((a,b)=> (a.year-b.year)||(a.month-b.month)).forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${r.month}/${r.year}</td><td>${r.elec.toFixed(2)} kg</td><td>${r.fuel.toFixed(2)} kg</td><td>${r.trans.toFixed(2)} kg</td><td>${r.waste.toFixed(2)} kg</td><td><strong>${r.total.toFixed(2)} kg</strong></td>`;
        tbody.appendChild(tr);
    });

    const totals = filtered.reduce((a,r)=>({elec:a.elec+r.elec,fuel:a.fuel+r.fuel,trans:a.trans+r.trans,waste:a.waste+r.waste,total:a.total+r.total}),{elec:0,fuel:0,trans:0,waste:0,total:0});
    const mapKpi = {kpiTotal:`${totals.total.toFixed(2)} kg CO₂`,kpiElec:`${totals.elec.toFixed(2)} kg`,kpiFuel:`${totals.fuel.toFixed(2)} kg`,kpiTrans:`${totals.trans.toFixed(2)} kg`,kpiWaste:`${totals.waste.toFixed(2)} kg`};
    Object.entries(mapKpi).forEach(([id,val])=>{const el=document.getElementById(id); if(el) el.textContent=val;});

    updateCharts([totals.elec,totals.fuel,totals.trans,totals.waste],[totals.elec,totals.fuel,totals.trans,totals.waste,totals.total],filtered.map(r=>`${r.month}/${r.year}`),filtered.map(r=>r.total));
}

function setupLazyCharts(){
    const obs = new IntersectionObserver(entries=>{
        entries.forEach(e=>{
            if(e.isIntersecting){
                e.target.classList.add('visible');
                if(!window.__chartsInitDone){window.__chartsInitDone=true; initCharts(); applyFilters();}
            }
        });
    },{threshold:0.2});
    ['compContainer','barContainer','trendContainer'].forEach(id=>{const el=document.getElementById(id); if(el) obs.observe(el);});
}

function exportCSV(){
    const headers=['Month/Year','Electricity','Fuel','Transport','Waste','Total'];
    const data=Array.from(document.querySelectorAll('#breakdownBody tr')).map(tr=>Array.from(tr.cells).map(td=>td.textContent));
    let csv= [headers.join(',')].concat(data.map(r=>r.join(','))).join('\n');
    const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='emissions.csv'; a.click(); URL.revokeObjectURL(url);
}

function exportPDF(){
    const rowsPdf = Array.from(document.querySelectorAll('#breakdownBody tr')).map(tr=>Array.from(tr.cells).map(td=>td.textContent));
    const doc = new jsPDF();
    doc.setFontSize(10);
    doc.text('Corporate Emissions',14,10);
    doc.autoTable({head:[['Month/Year','Electricity','Fuel','Transport','Waste','Total']],body:rowsPdf,startY:15,theme:'grid',styles:{fontSize:9}});
    doc.save('emissions.pdf');
}

document.addEventListener('DOMContentLoaded',()=>{
    document.getElementById('yearFilter').addEventListener('change',applyFilters);
    document.getElementById('monthFilter').addEventListener('change',applyFilters);
    document.getElementById('exportCsv').addEventListener('click',exportCSV);
    document.getElementById('exportPdf')?.addEventListener('click',exportPDF);
    setupLazyCharts();
});
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
    window.jsPDF = window.jspdf.jsPDF;
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


